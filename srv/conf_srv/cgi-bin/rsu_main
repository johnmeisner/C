#!/bin/bash

# File: rsu_main

SCRIPT_PATH="/usr/local/www/cgi-bin"

# This script verifies user's IP is logged in, and then generates the rsu_main (main landing page) content

function print_no_cache()
{
echo "    <meta http-equiv=\"Pragma\" content=\"no-cache\">" 
echo "    <meta http-equiv=\"Expires\" content=\"0\">" 
echo "    <meta http-equiv=\"CACHE-CONTROL\" content=\"NO-CACHE\">" 
}

#
# print_header()
# desc: print page header with all the css and js needed to format page
#
function print_header()
{
echo "<!DOCTYPE html>"
echo "<!-- GENERATED BY /cgi-bin/rsu_main -->"  
echo "<html>" 

echo "<head>" 
echo "    <meta charset=\"utf-8\">" 
echo "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, shrink-to-fit=no\">" 
print_no_cache
echo "    <title>RSU - 5940</title>" 
echo "    <link rel=\"stylesheet\" href=\"/assets/bootstrap/css/bootstrap.min.css\">" 
echo "    <link rel=\"stylesheet\" href=\"/assets/fonts/font-awesome.min.css\">" 
echo "    <link rel=\"stylesheet\" href=\"/assets/css/Features-Boxed.css\">" 
echo "    <link rel=\"stylesheet\" href=\"/assets/css/Features-Clean.css\">" 
echo "    <link rel=\"stylesheet\" href=\"/assets/css/Footer-Basic.css\">" 
echo "    <link rel=\"stylesheet\" href=\"/assets/css/styles.css\">" 

echo "</head>" 
}

function print_feature_box_beg()
{
echo "<body " 
# Onload start multiple timers
#   - UTC and uptime refresh - every one second
#   - UTC and uptime update request - every 5 minutes

echo "onload=\"start_timer()\" >" 

source $SCRIPT_PATH/add_navbar.sh
source $SCRIPT_PATH/add_page_timeout.sh

echo "    <div class=\"features-boxed\">" 
echo "        <div class=\"container\">" 
}

function print_feature_box_end()
{
echo "        </div>" 
echo "    </div>" 
}

function print_intro_beg()
{
echo "            <div class=\"intro\">" 
echo "            <br/>" 
echo "                <h2 class=\"text-center\">MobiQ RSU User Interface</h2>" 
}

function print_intro_end()
{
echo "            </div>" 
}

function print_class_row_beg()
{
echo "            <div class=\"row justify-content-center features\">" 
}

function print_class_row_end()
{
echo "            </div>" 
}

function print_config_box()
{
echo "                <div class=\"col-sm-6 col-md-5 col-lg-4 item\">" 
# Note : config_display script for full developer Settings
#        config_display_default script expose default allowable settings for customers
echo "                  <a href=\"/cgi-bin/config_display_default\">" 
echo "                    <div class=\"shadow p-3 mb-5 bg-white rounded\"><i class=\"fa fa-list-alt icon\"></i>" 
echo "                        <h3 class=\"name\">Configuration Settings</h3>" 
echo "                    </div>" 
echo "                  </a>" 
echo "                </div>" 

echo "                <div class=\"col-sm-6 col-md-5 col-lg-4 item\">" 
# Note : config_display script for full developer Settings
#        config_display_default script expose default allowable settings for customers
echo "                  <a href=\"/cgi-bin/config_advanced_live\">" 
echo "                    <div class=\"shadow p-3 mb-5 bg-white rounded\"><i class=\"fa fa-bullseye icon\"></i>" 
echo "                        <h3 class=\"name\">Advanced Config Settings</h3>" 
echo "                    </div>" 
echo "                  </a>" 
echo "                </div>" 
}

function print_status_box()
{
echo "                <div class=\"col-sm-6 col-md-5 col-lg-4 item\">" 
echo "                  <a href=\"/cgi-bin/status_display_live\">" 
echo "                    <div class=\"shadow p-3 mb-5 bg-white rounded\"><i class=\"fa fa-heartbeat icon\"></i>" 
echo "                        <h3 class=\"name\">Status</h3>" 
echo "                    </div>" 
echo "                  </a>" 
echo "                </div>" 

echo "                <div class=\"col-sm-6 col-md-5 col-lg-4 item\">" 
echo "                  <a href=\"/cgi-bin/status_advanced_live\">" 
echo "                    <div class=\"shadow p-3 mb-5 bg-white rounded\"><i class=\"fa fa-bullhorn icon\"></i>" 
echo "                        <h3 class=\"name\">Advanced Status</h3>" 
echo "                    </div>" 
echo "                  </a>" 
echo "                </div>" 
}

function print_util_box()
{
echo "                <div class=\"col-sm-6 col-md-5 col-lg-4 item\">" 
echo "                  <a href=\"/cgi-bin/util_display_live\">" 
echo "                    <div class=\"shadow p-3 mb-5 bg-white rounded\"><i class=\"fa fa-cogs icon\"></i>" 
echo "                        <h3 class=\"name\">Utilities</h3>" 
echo "                    </div>" 
echo "                  </a>" 
echo "                </div>" 
}

function print_fw_version()
{
  # FW version
  echo "      <p class=\"copyright\" style='color:#aaa;text-align:center;font-size:13px;margin-bottom: 0px;'>" 
  echo VERSION: 
  cat /etc/version 
  echo "      </p>" 
}  

#
# print_footer_end()
# desc: footer and end of page
#
function print_footer_end()
{
echo "    <div class=\"footer-basic\">" 
echo "        <footer>" 
echo "            <p class=\"copyright\">MobiQ Â© 2023</p>" 
echo "        </footer>" 
echo "    </div>" 
echo "    <script src=\"/assets/js/jquery.min.js\"></script>" 
echo "    <script src=\"/assets/bootstrap/js/bootstrap.min.js\"></script>" 

    #=== Custom scripts ===
    echo "<script>" 
        print_pageshow_update
        print_update_rsu_time
        print_start_timers
        print_rsu_time_refresh
    echo "</script>" 

echo "</body>" 
echo "</html>" 
}

function print_update_rsu_time()
{
    echo "    function update_rsu_time() {" 
    echo "      var xhttp = new XMLHttpRequest();" 
    echo "      xhttp.onreadystatechange = function() {" 
    echo "        if (this.readyState == 4 && this.status == 200) {" 

    echo "          var str = this.responseText;" 
    echo "          var res = str.replace(\"GMT\", \"UTC\");" 
    echo "          msec = Date.parse(res);" 
                    # Kicks off refresh timer for updating time per second without pinging server
    echo "          rsu_time_refresh();" 
    #echo "          var t = setTimeout(update_rsu_time, 1000);" 
    echo "        }" 
    echo "      };" 
    echo "      xhttp.open(\"GET\", \"/cgi-bin/update_time\", true);" 
    echo "      xhttp.send();" 
    echo "    }" 
}

function print_rsu_time_refresh()
{
    echo "    function rsu_time_refresh() {" 
#    echo "      msec = msec + 1000;" 
    echo "      var n_date = new Date(msec);" 
    echo "      var utc_date = n_date.toUTCString();" 
    echo "      var utc_date = utc_date.replace(\"GMT\", \"UTC\");" 
    echo "      document.getElementById(\"rsu_time\").innerHTML = utc_date;" 
    echo "      msec = msec + 1000;" 
    echo "      var t = setTimeout(rsu_time_refresh, 1000);" 
    echo "    };" 
}


# Kicks off mulitple timers
function print_start_timers()
{
    echo "    function start_timer() {" 
    # Get RSU UTC time from RSU as a baseline, then kick off refresh timer to update every one second
    echo "      update_rsu_time();" 
    # Additional timers if nedded

    echo "    }" 
}

function print_pageshow_update()
{
    # Add listener for pageshow event
    echo "    addEventListener(\"pageshow\", pageshow_update); " 

    # resync with server for proper time - updating msec
    echo "    function pageshow_update() {"  
    echo "      var xhttp = new XMLHttpRequest();"  
    echo "      xhttp.onreadystatechange = function() {"  
    echo "        if (this.readyState == 4 && this.status == 200) {"  

    echo "          var str = this.responseText;"  
    echo "          var res = str.replace(\"GMT\", \"UTC\");"  
    echo "          msec = Date.parse(res);"  
    echo "        }"  
    echo "      };"  
    echo "      xhttp.open(\"GET\", \"/cgi-bin/update_time\", true);"  
    echo "      xhttp.send();"  
    echo "    }"  
}

#====== Main

#
### Output new page - redirect to main page if sucessfull
#

echo "Content-type: text/html"
echo ""

# Check login status - logged out if 0.0.0.0, else returns ip of current client
LOGGED_IP=`/usr/bin/conf_agent SESSION_CHK $REMOTE_ADDR`
if [ "$LOGGED_IP" != "$REMOTE_ADDR" ]; then 
  # Goto timeout page
  echo "<meta http-equiv=\"refresh\" content=\"0; URL='/rsu-timeout.html' \" /> "

else
  print_header                   # print header
  print_feature_box_beg          # print intro beg
  print_intro_beg 
  print_intro_end 

  # Status from previous save, from user who made changes on a config form, hit "BACK", and then OK to save
  STATUS_FILE=/tmp/update.status.file
  if [ -f $STATUS_FILE ]; then
    echo '<center>'
    cat $STATUS_FILE
    rm -f $STATUS_FILE
    echo '</center><br/>'
  fi

  # main body show 3 boxes "config", "status", and "utilities"
  print_class_row_beg 
  # Config box
  print_config_box 
  # Status box
  print_status_box 
  # Utilities box
  print_util_box 

  print_class_row_end 
  # Insert time and date
  echo "      <h4 class=\"text-center\" id=\"rsu_time\"></h4>"  

  print_feature_box_end 

  print_fw_version

  # End of Page with Footer
  print_footer_end  

fi
